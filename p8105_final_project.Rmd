---
title: "p8105_final_project"
author: "Yulan Zhang"
date: "November 2, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load lib, include=FALSE}
library(tidyverse)
library(rvest)
library(httr)
library(janitor)
library(stringr)
library(readxl)
library(plotly)
library(dplyr)
library(viridisLite)
library(forecast)
library(flexdashboard)
library(fiftystater)
library(RColorBrewer)
library(broom)
library(knitr)
library(gapminder)
```


```{r load data}
cod_data = read_csv("./data/NCHS_-_Potentially_Excess_Deaths_from_the_Five_Leading_Causes_of_Death.csv") %>%
  clean_names() %>%
  na.omit() %>%
  filter(!(state == "United States")) %>%
  separate(., percent_potentially_excess_deaths, into = c("percent_excess_death"), sep = "%") %>%
  mutate(percent_excess_death = as.numeric(percent_excess_death), mortality = observed_deaths/population * 10000, mortality = as.numeric(mortality)) %>%
  select(year, cause_of_death, state, locality, observed_deaths, population, expected_deaths, potentially_excess_deaths, percent_excess_death, mortality, hhs_region)

##columns removed

 #"state_fips_code"                      "age_range"    "benchmark"   "potentially_excess_deaths" "percent_excess_death"      "mortality"   

```
- the `year` variable contains data collected from 2005-2015.
- filtered out `United States` in the `state` variable.
- Added a variable `mortality` which is calculated by observed_deaths/population * 10000. This variable indicates the number of deathes observed in every 10000 people in the three geographic regions: `Metropolitan`, `Nonmetropolitan` and `All`.  



xs2329:
This bar graph shows the distribution of cause of death within mortality in the three geographic regions: `Metropolitan`, `Nonmetropolitan` and `All`. 

```{r xs2329 plot}
cod_data %>%
  group_by(cause_of_death) %>% 
  ggplot(aes(x = locality, y = mortality, fill = cause_of_death)) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title="Locality vs. Mortality") +
  labs(x="locality", y="mortality") 
```

```{r xs2329 boxplot}
cod_data %>%
  group_by(cause_of_death) %>% 
  ggplot(aes(x = locality, y = mortality)) + geom_boxplot(aes(color = cause_of_death), na.rm = T) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title="Locality vs. Mortality") +
  labs(x="locality", y="mortality") 
```



```{r xs2329 lm}
mortality_lm = lm(mortality ~locality, data = cod_data)
summary(mortality_lm)
```
interpretation on linear regression:
We expect to see 0.22576 less deaths for every 10000 people in metropolitan region as compared to all regions. 
We expect to see 1.14451 more death for every 10000 people in nonmetropolitan region as compared to all regions.





<<<<<<< HEAD
```{r wp2241}
### Question of concern: If percent excess death has significant difference between metro and non-metro groups.
gp_cod_data = cod_data %>%
  group_by(year, locality)%>% 
  summarise(mean_ped = mean(percent_excess_death)) #doesn't work. Ask TA.

ggplot(gp_cod_data, aes(x = year, y = mean_ped, fill = locality)) + geom_bar(stat = "identity")+
facet_grid(. ~ locality) 

```

```{r wp2241 reg}
gp_locality_lm = lm(percent_excess_death ~locality, data = cod_data)
broom::tidy(gp_locality_lm)
```


=======


<<<<<<< HEAD
=======
<<<<<<< HEAD

```{r cl3664 data}
# How should we help nonmetropolitan areas improve public health? 
cod_datayr2 = read_csv("./data/NCHS_-_Potentially_Excess_Deaths_from_the_Five_Leading_Causes_of_Death.csv") %>%
  clean_names() %>%
  na.omit() %>%
  filter(!(state == "United States")) %>%
  separate(., percent_potentially_excess_deaths, into = c("percent_excess_death"), sep = "%") %>%
  mutate(percent_excess_death = as.numeric(percent_excess_death), mortality = observed_deaths/population * 10000, mortality = as.numeric(mortality)) %>%
  select(year, cause_of_death, state, benchmark, locality, observed_deaths, population, expected_deaths, potentially_excess_deaths, percent_excess_death, mortality)
```
average percent access death for each cause in different locality 2005-2015
```{r cl3664 plot}
cod_datayr2%>%
  filter(benchmark == "2010 Fixed")%>%
  group_by(cause_of_death,year, locality)%>%
  mutate(year_percent_death=mean(percent_excess_death))%>%
  distinct(year, cause_of_death, locality, .keep_all = TRUE)%>%
  ungroup(year, locality)%>%
  ggplot(aes(x = year, y = year_percent_death))+
  geom_line(aes(color = cause_of_death),size = 1) +
  facet_grid(.~locality)+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  labs(title = "Average yearly percent deaths for different locality and benchmarks") 

```

```{r cl3664 lm}
cod_datayrlm = cod_datayr2%>%
  filter(locality == "Nonmetropolitan",
         benchmark == "2010 Fixed")
lmpop = lm(data=cod_datayrlm, percent_excess_death~year+cause_of_death)
summary(lmpop)
```

Based on 2010 fixed benchmark, unintentional injury and chronic lower respiratory disease has on average the highest excess death percentage in nonmetropolitan areas and needs more attention from public health experts. 


```{r yz3306.1}
#For each of the five cause of death, what is the mean percent of excess death? It is different across locality.
library(forcats)
names(cod_data)
cod_data %>%
  na.omit %>%
  group_by(cause_of_death) %>%
  mutate(mean_percent_excess_death = mean(percent_excess_death)) %>%
  ungroup(cause_of_death) %>%
  mutate(cause_of_death = fct_reorder(cause_of_death, mean_percent_excess_death)) %>%
  ggplot(aes(x = cause_of_death, y = percent_excess_death, fill = cause_of_death)) +
  geom_boxplot() +
  facet_grid(~locality) +
  theme(axis.text.x = element_text(angle = 20, hjust = 1))  +
  theme(legend.position = "bottom")

##As shown in the boxplots for all three regions, the rank of the five cause of death remain the same for different localities. For all five causes, the mean percent of death is lower for `Metropolitan` and higher for `Nonmetropolotan`, with respect to `All` Locality.
```

yz3306: As shown in the boxplots for all three regions, the rank of the five cause of death remain the same for different localities. For all five causes, the mean percent of death is lower for `Metropolitan` and higher for `Nonmetropolotan`, with respect to `All` Locality.

yz3306:regress percent of excess death on cause of death, which is a categorical variable. with respect to cancer, the least of the five causes, all 4 have additional percent of death as evaluated by the estimates. The results give statisically significant estimates .

```{r yz3306.2}

cod_lm_yz1 = lm(percent_excess_death ~cause_of_death, data = cod_data)
broom::tidy(cod_lm_yz1)

#cod_lm_yz2 = lm(percent_excess_death ~locality, data = cod_data)
#broom::tidy(cod_lm_yz2)

cod_lm_yz3 = lm(percent_excess_death ~cause_of_death + locality, data = cod_data)
broom::tidy(cod_lm_yz3)
```

```{r Questions}
#Do we need to include the plot of the linear model? Some plots. 
#Why is everything significant? Is there a problem? Don't focus on p-value. Calculate CI and other estimates.
#How to make a scatterplot for regression with catagorical variables? We don't need to.
#How to interpret percent excess death? According to the benchmark of the three lowest states.
#How to make a map? Still under investigation...
```

```{r}
map_cod_data = cod_data %>%
  filter(locality == "Metropolitan") %>%
  select(state, locality, percent_excess_death) %>% 
  group_by(state) %>% 
  summarise(mean_ped = mean(percent_excess_death)) %>% 
  dplyr::filter(!(state == "District of\nColumbia"))
  

map = as.tibble(fifty_states) %>%
  group_by(id) %>% 
  summarize(clong = mean(long), clat = mean(lat)) %>% 
  filter(!(id == "district of columbia"))

df <- cbind(map, state.abb, state.center, rate = unique(map_cod_data$mean_ped))

ggplot(df, aes(map_id = id)) + 
    geom_map(aes(fill = rate), map = fifty_states) + 
    expand_limits(x = fifty_states$long, y = fifty_states$lat) + 
    labs(x = "", y = "") +
    theme(panel.background = element_blank(), 
          axis.text.x = element_blank(), 
          axis.text.y = element_blank(), 
          axis.ticks = element_blank()) + 
    geom_text(aes(x = clong, y = clat, label = state.abb)) 


```

```{r}
p <- ggplot(gapminder, aes(gdpPercap, lifeExp, color = continent)) +
  geom_point(aes(size = pop, frame = year, ids = country)) +
  scale_x_log10()

p <- ggplotly(p) %>% 
  animation_opts(
    1000, easing = "elastic", redraw = FALSE
  ) %>% 
  animation_button(
    x = 1, xanchor = "right", y = 0, yanchor = "bottom"
  ) %>%
  animation_slider(
    currentvalue = list(prefix = "YEAR ", font = list(color="red"))
  )

```



```{r}
region_cod_data = cod_data %>%
  select(state, locality, hhs_region, percent_excess_death) %>% 
  group_by(state,locality, hhs_region) %>% 
  summarise(mean_ped = mean(percent_excess_death)) %>% 
  dplyr::filter(!(state == "District of\nColumbia")) %>% 
  mutate(hhs_region = as.character(hhs_region))


region_lm = lm(region_cod_data$mean_ped~region_cod_data$hhs_region)
rl1 = broom::tidy(region_lm)
kable(rl1)

region_locality_lm =lm(region_cod_data$mean_ped ~ region_cod_data$hhs_region+region_cod_data$locality)
rl2 = broom::tidy(region_locality_lm)
kable(rl2)
```

Interpretation: U.S. Department of Health and Human Services public health regions (1 through 10) are used as a categorical variable in the above regressions. Specific region classification is shown in the figure below.

[attach image here].

As shown in the above summary tables, with respect to region 1, only region 2 have negative estimated coefficient, indicating less mean percentage of excess death . Specifically, comparing with region 1, region 2 have 1.67% less mean percentage of excess death on average. From region 3 to region 10, the mean percentage of excess death is higher comparing with region 1. Similiar results yield from regression adjusted for Locality. Adjusting locality, region 4 and 6 have top two highest increase in mean percetage of excess death with respect to region 1. Adjusting for different regions, similar result yield that, on average, metropolitan have 2% less than overall mean percetage of excess deaths and nonmetropolitan have 7% more than overall mean percetage of excess death.
















